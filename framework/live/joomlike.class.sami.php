<?php		class JL {				// TODO: url rewriting		function url($url) {			return $url;		}				// retourne true si le membre est abonn�, sinon false		function checkAbonnement() {			global $user;			return ($user->gold_limit_date == '1970-01-01' || ($user->gold_limit_date != '1970-01-01' && strtotime($user->gold_limit_date) < time())) ? false : true;		}				// crypte les adresses mail et url		function messageEncode($texte, $replacement) {				    // convert support@pogoda.in		    $texte = ereg_replace('[-a-z0-9!#$%&\'*+/=?^_`{|}~.]+ *(@|\(at\)|\( at \)| \( at \) ) *([.]?[a-zA-Z0-9_/-])*', $replacement, $texte);		    // convert http://www.pogoda.in/new_york/eng/		    $texte = ereg_replace('[a-zA-Z]+://(([.]?[a-zA-Z0-9_/-])*)', $replacement, $texte);		    // convert www.pogoda.in/new_york/eng/		    $texte = ereg_replace('(www([-]*[.]?[a-zA-Z0-9_/-?&%])*)', $replacement, $texte);		   		    return $texte;					}				// ajoute des htmlentities � chaque champ d'un objet, en excluant les champs pr�sents dans la chaine $exclure		function makeSafe(&$obj, $exclure = '') {			$exclusion	= array();			if($exclure) {				$exclusion	= explode(',', $exclure);			}			if(is_object($obj)) {				foreach($obj as $k => $v) {										if(!in_array($k, $exclusion)) {						$obj->{$k} = makeSafe($v);					}				}			} elseif(is_array($obj)) {				foreach($obj as $k => $v) {					if(!in_array($k, $exclusion)) {						$obj[$k] = makeSafe($v);					}				}			}		}						// v�rifie si l'application � charger existe, et que le visiteur n'essaye pas divers hacks dans l'url avec la variable $app		function checkApp($app_load, $admin = '') {						// variables			$app_ok	= true;						// on conserve uniquement les caract�res alphanum�riques et _			$app_load_check	= preg_replace('#[^a-z0-9_]#', '', $app_load);						// d�termine si c'est une appli admin ou visiteur			if(!$admin) { // app cot� front				$path	= SITE_PATH;			} else { // app cot� back				$path	= SITE_PATH_ADMIN;			}						// si le nom de l'application n'est pas correct			if($app_load_check != $app_load) {				$app_ok	= false;			} elseif(!is_file($path.'/app/app_'.$app_load.'/'.$app_load.'.php')) { // si le chemin de l'application qui semble correcte n'existe pas				$app_ok	= false;			}						// retourne vrai si on peut charger l'application			return $app_ok;					}						// charge le corps de la page, en pr�cisant en param si c'est une appli $admin (charge par d�faut le $app)		function loadBody($admin = '') {			global $app;			JL::loadApp($app, $admin);		}						// charge l'application pass�e en param		function loadApp($app_load, $admin = '') {						// d�termine si c'est une appli admin ou visiteur			if(!$admin) { // app cot� front				$path	= SITE_PATH;			} else { // app cot� back				$path	= SITE_PATH_ADMIN;			}						// si l'application est valide			if(JL::checkApp($app_load, $admin)) {				include($path.'/app/app_'.$app_load.'/'.$app_load.'.php'); // charge l'application			} else {				echo 'Application introuvable.'; // application charg�e � la main, depuis une autre application, sinon une erreur 404 aurait �t� lev�e			}					}						// charge le module pass� en param		function loadMod($mod, $admin = '') {						// d�termine si c'est une appli admin ou visiteur			if(!$admin) { // app cot� front				$path	= SITE_PATH;			} else { // app cot� back				$path	= SITE_PATH_ADMIN;			}						if(is_file($path.'/mod/mod_'.$mod.'.php')) {				include($path.'/mod/mod_'.$mod.'.php');			} else {				echo 'Module ['.$mod.'] introuvable.';			}		}						// r�cup une variable en request		function getVar($key, $defaut, $addslashes = false) {			if($addslashes) {				return isset($_REQUEST[$key]) ? addslashes($_REQUEST[$key]) : addslashes($defaut);			} else {				return isset($_REQUEST[$key]) ? $_REQUEST[$key] : $defaut;			}		}				function cleanVar($value) {			return trim(str_replace('�', '\'', $value));		}				// ajoute une variable en request		function setVar($key, $value) {			$_REQUEST[$key]	= $value;		}						// r�cup une variable en session		function getSession($key, $defaut, $addslashes = false) {			if($addslashes) {				return isset($_SESSION[$key]) ? (!is_array($_SESSION[$key]) ? addslashes($_SESSION[$key]) : $_SESSION[$key]) : (!is_array($defaut) ? addslashes($defaut) : $defaut);			} else {				return isset($_SESSION[$key]) ? $_SESSION[$key] : $defaut;			}		}						// r�cup une variable en session, en retournant un int		function getSessionInt($key, $defaut) {			return isset($_SESSION[$key]) ? intval($_SESSION[$key]) : intval($defaut);		}						// ajoute une variable en session		function setSession($key, $value) {			$_SESSION[$key]	= $value;		}						// retourne le timestamp en microsecondes		function microtime_float() {			list($usec, $sec) = explode(" ", microtime());			return ((float)$usec + (float)$sec);		}						// d�truit compl�tement la session de l'utilisateur		function sessionDestroy() {						// d�truit toutes les variables de session			$_SESSION = array();						// d�truit le cookie de session.			if (isset($_COOKIE[session_name()])) {			    setcookie(session_name(), '', time()-42000, '/');			}						// d�truit la session.			session_destroy();					}								// envoie un mail en html		function mail($destinataire, $titre, $texte, $utf8 = true) {						// headers			$headers = 'Mime-Version: 1.0'."\r\n";			$headers = 'From: "'.SITE_MAIL_FROM.'" <'.SITE_MAIL.'>'."\r\n";			$headers .= 'Content-type: text/html; charset='.($utf8 ? 'utf-8' : 'iso-8859-1')."\r\n";			//$headers .= "\r\n";						// envoi du mail			if($utf8) {				mail($destinataire, utf8_encode($titre), utf8_encode($texte), $headers);			} else {				mail($destinataire, $titre, $texte, $headers);			}		}						// cr�e le dossier d'upload temporaire, et enregistre le nom du dossier en session		function makeUploadDir() {			global $user;						$dir_temp = 'images/profil';						if($user->id) {				$upload_dir = $user->id;			} else { 				$upload_dir = JL::getSession('upload_dir', 0);				if(!$upload_dir) {					do {						$upload_dir = JL::microtime_float()*10000;					} while(is_dir($dir_temp.'/'.$upload_dir));				}			}			JL::setSession('upload_dir', $upload_dir);						$dest_dossier	= $dir_temp.'/'.$upload_dir;			if(!is_dir($dest_dossier)) {				mkdir($dest_dossier,0777);				chmod($dest_dossier,0777);			}					}				// affichage des messages syst�me		function messages(&$messages) {						// s'il y a des messages � afficher			if (is_array($messages)) {				// pour chaque message				foreach($messages as $message) {					echo $message;				}			}					}				function redirect($url) {			if (headers_sent()) {				echo "<script>document.location.href='".JL::url($url)."';</script>\n";			} else {				@ob_end_clean();				header( 'HTTP/1.1 301 Moved Permanently' );				header( "Location: ".JL::url($url));			}			exit();		}						// retourne l'url de la photo num�ro $photo_i, de type $photo_type, de l'utilisateur $user_id		function userGetPhoto($user_id, $photo_format, $photo_type, $photo_i) {						// variables			$dir = 'images/profil/'.$user_id;						// ajout d'un s�parateur si besoin est			if($photo_type) {				$photo_type = '-'.$photo_type;			}						// photo existe			if(is_file(SITE_PATH.'/'.$dir.'/parent-solo-'.$photo_format.$photo_type.'-'.$photo_i.'.jpg')) {								return SITE_URL.'/'.$dir.'/parent-solo-'.$photo_format.$photo_type.'-'.$photo_i.'.jpg';							} else { // photo n'existe pas								// test sur les 6 photos				for($i=1;$i<=6;$i++) {					if(is_file(SITE_PATH.'/'.$dir.'/parent-solo-'.$photo_format.$photo_type.'-'.$i.'.jpg')) {												// retourne la premi�re photo trouv�e						return SITE_URL.'/'.$dir.'/parent-solo-'.$photo_format.$photo_type.'-'.$i.'.jpg';											}				}								return false;							}					}						function notificationBasique($type = 'visite', $profil_id) {			global $db, $user;						// variables			$titre	= array(				'visite' 	=> $user->username." a consult� votre profil",				'message' 	=> $user->username." vous a envoy� un message",				'fleur' 	=> $user->username." vous a envoy� une fleur"			);						$intro	= array(				'visite' 	=> "Vous avez re&ccedil;u une nouvelle visite !",				'message' 	=> "Vous avez re&ccedil;u un nouveau message !",				'fleur' 	=> "Vous avez re&ccedil;u une nouvelle fleur !"			);						$texte	= array(				'visite' 	=> "Vous pouvez vous aussi \n<br /><a href='".JL::url(SITE_URL.'/index.php?app=profil&action=view&id='.$user->id)."'>consulter son profil</a>...<br /><br /> Et pourquoi pas lui <br /><a href='".JL::url(SITE_URL.'/index.php?app=message&action=write&user_to='.$user->username)."'>envoyer un message</a> ?",				'message' 	=> "Vous pouvez vous aussi \n<br />lui <a href='".JL::url(SITE_URL.'/index.php?app=message&action=write&user_to='.$user->username)."'>envoyer un message</a>...<br /><br /> Et pourquoi pas <br /><a href='".JL::url(SITE_URL.'/index.php?app=profil&action=view&id='.$user->id)."'>consulter son profil</a> ?",				'fleur' 	=> "Vous pouvez vous aussi \n<br />lui <a href='".JL::url(SITE_URL.'/index.php?app=message&action=flower&user_to='.$user->username)."'>envoyer une fleur</a>...<br /><br /> Et pourquoi pas <br /><a href='".JL::url(SITE_URL.'/index.php?app=profil&action=view&id='.$user->id)."'>consulter son profil</a> ?"			);						$icone	= array(				'visite' 	=> 'icone-visite.jpg',				'message' 	=> 'icone-message.jpg',				'fleur' 	=> 'icone-fleur.jpg'			);						// r�cup les infos du profil			$query = "SELECT u.id, u.username, u.email, up.genre, up.photo_defaut, un.new_".$type			." FROM user AS u"			." INNER JOIN user_profil AS up ON up.user_id = u.id"			." INNER JOIN user_notification AS un ON un.user_id = u.id"			." WHERE u.id = '".$profil_id."'"			." LIMIT 0,1"			;			$profil = $db->loadObject($query);						if((int)$profil->{'new_'.$type}) {								// r�cup les infos de l'utilisateur log				$query = "SELECT up.photo_defaut, IFNULL(pc.nom, '') AS canton, up.nb_enfants, up.genre, CURRENT_DATE, (YEAR(CURRENT_DATE)-YEAR(up.naissance_date)) - (RIGHT(CURRENT_DATE,5)<RIGHT(up.naissance_date,5)) AS age"				." FROM user AS u"				." INNER JOIN user_profil AS up ON up.user_id = u.id"				." LEFT JOIN profil_canton AS pc ON pc.id = up.canton_id"				." WHERE up.user_id = '".$user->id."'"				." LIMIT 0,1"				;				$userLog = $db->loadObject($query);								// r�cup la photo par d�faut du profil				$photoDefautProfil 	= JL::userGetPhoto($profil->id, 'preview', 'profil', $profil->photo_defaut);				if(!$photoDefautProfil) {					$photoDefautProfil = SITE_URL.'/parentsolo/images/parent-solo-preview-'.$profil->genre.'.jpg';				}							// r�cup la photo par d�faut de l'utilisateur log				$photoDefautUser 	= JL::userGetPhoto($user->id, 'mini', 'profil', $userLog->photo_defaut);				if(!$photoDefautUser) {					$photoDefautUser = SITE_URL.'/parentsolo/images/profil-parentsolo-'.$userLog->genre.'.jpg';				}								// r�cup les stats du compte				$query = "SELECT visite_total, fleur_new, message_new, CURRENT_DATE, IF(gold_limit_date > CURRENT_DATE, 1, 0) AS gold, gold_limit_date"				." FROM user_stats"				." WHERE user_id = '".$profil->id."'"				." LIMIT 0,1"				;				$userStats = $db->loadObject($query);												$imgUrl	= SITE_URL."/images/mail";				$sujet 	= "SoloCircl.com - ".$titre[$type];				$headers ='From: "'.SITE_MAIL_FROM.'" <'.SITE_MAIL.'>'."\n";				$headers .='Reply-To: '.SITE_MAIL."\n";				$headers .='Content-Type: <html>tml; charset="iso-8859-1"'."\n";				$headers .='Content-Transfer-Encoding: 8bit';				$message ="<html><head><title>".makeSafe($sujet)."</title></head>\n"				."<body style='background-color:rgb(0,0,0);'>\n"				."<div style='padding: 20px;background-color:\n rgb(0, 0, 0);color:rgb(255, 255, 255);'>\n"				."<table style='font-family:Verdana;'>\n"								."<tr><td style='width:217px;height:171px;'><a href='".SITE_URL."'>\n<img src='".$imgUrl."/logo.jpg' border='0' /></a></td>\n"				."<td style='width:92px;height:97px;padding:74px 0px 0px 108px;vertical-align:top;\n background-image:url(".$imgUrl."/photo.jpg);'\n background='".$imgUrl."/photo.jpg'>\n"				."<img src='".$photoDefautProfil."' border='0' /></td>\n"				."<td style='width:293px;height:111px;color:rgb(255,255,255);\n background-color:rgb(0,0,0);padding:60px 0px 0px 10px;font-size:12px;'>\n<b>".$profil->username."</b><br />\n"				."Vous avez re&ccedil;u <span style='color:rgb(205,1,114);font-weight:bold;'>\n".$userStats->visite_total."</span> visite".($userStats->visite_total > 1 ? 's' : '').".<br />\n"				."Vous avez <span style='color:rgb(205,1,114);font-weight:bold;'>\n".$userStats->message_new."</span> nouveau".($userStats->message_new > 1 ? 'x' : '')." message".($userStats->message_new > 1 ? 's' : '').".<br />\n"				."Vous avez <span style='color:rgb(205,1,114);font-weight:bold;'>\n".$userStats->fleur_new."</span> nouvelle".($userStats->fleur_new > 1 ? 's' : '')." fleur".($userStats->fleur_new > 1 ? 's' : '').".<br />\n"				."<span style='background-color:rgb(255,153,204);display:block;width:210px;\n text-align:left;font-size:12px;margin:2px 0px 0px 0px;\n padding:2px 5px 2px 5px;color:rgb(0,0,0);'>".($userStats->gold ? "<b>Fin d'abonnement:</b>\n&nbsp;<span style='color:rgb(205,1,114);font-weight:bold;'>\n".date('d/m/y', strtotime($userStats->gold_limit_date))."</span>" : "<b>Membre:</b> <a href='".JL::url(SITE_URL.'/index.php?app=abonnement&action=tarifs')."'\n style='color:rgb(205,1,114);font-weight:bold;'>Abonnez-vous !</a>")."</span></td></tr>\n"								."<tr><td colspan='3' style='width:720px;height:429px;\n background-image:url(".$imgUrl."/bg.jpg);\n vertical-align:top;'\n background='".$imgUrl."/bg.jpg'>\n"								."<span style='display:block;padding:20px 0px 0px 20px;height:20px;\n color:rgb(255,153,51);font-size:18px;font-weight:bold;'>\n".$intro[$type]."</span>\n"								."<div style='padding:60px 0px 0px 20px;'>\n"				."<table style='font-family:Verdana;'><tr><td style='width:105px;height:164px;padding:0px;\n background-image:url(".$imgUrl."/profil.gif);\n vertical-align:top;background-repeat:no-repeat;'\n background='".$imgUrl."/profil.gif' valign='top'>\n<div style='height:20px;line-height:20px;\n font-size:12px;color:rgb(255,255,255);padding:2px 0px 0px 5px;'>".$user->username."</div>\n<div style='height:100px;padding: 0px 0px 0px 2px'>\n<img src='".$photoDefautUser."' border='0' />\n<div style='padding:1px 4px 0px 4px;color:rgb(0,0,0);font-size:11px;line-height: 12px;'>\n	".$userLog->age." ans<br />".$userLog->nb_enfants." enfant".($userLog->nb_enfants > 1 ? 's' : '')."<br />\n".makeSafe($userLog->canton)."</div></td>\n"								."<td style='font-size:14px;font-weight:bold;\n background-image:url(".$imgUrl."/box.jpg);\n color:rgb(205,1,114);\n text-align:center;vertical-align:middle;width:339px;\n height:164px;padding:0px 20px 0px 20px;'\n background='".$imgUrl."/box.jpg'>\n"				.$titre[$type]." !\n<br /><br />".$texte[$type]."</td>\n"								."<td style='width:120px;height:164px;vertical-align:top;padding:0px;' valign='top'><a href='".JL::url(SITE_URL.'/index.php?app=message&action=flower&user_to='.$user->username)."'\n style='display:block;width:119px;height:32px;margin:0px;padding:0px;'><img\n src='".$imgUrl."/rose2.jpg' border='0' /></a><img\n src='".$imgUrl."/".$icone[$type]."' style='display:block;margin:0px;padding:0px;width:119px;height:100px;' /><a\n href='".JL::url(SITE_URL.'/index.php?app=message&action=write&user_to='.$user->username)."'\n style='display:block;width:119px;height:29px;margin:0px;padding:0px;'><img\n src='".$imgUrl."/message2.jpg' border='0' /></a></td></tr></table></div>\n"								."<span style='font-family:Verdana;display:block;padding:80px 0px 0px 20px;width:570px;\n color:rgb(55,55,55);\n font-size:11px;font-style:italic;'>\nSi vous ne souhaitez\n plus recevoir cet email, connectez-vous &agrave; votre compte sur SoloCircl.com,\n puis allez dans &quot;Mes notifications&quot;, et d&eacute;cochez la case\n qui correspond &agrave; cet email.</span>\n"								."</td></tr>\n"								."</table></div></body></html>"				;				mail($profil->email, $sujet, $message, $headers);							}					}						// conserve le dernier �v�nement effectu� sur un profil		function addLastEvent($user_id = 0, $last_event_user_id = 0, $last_event_type = 0, $last_event_data = 0) {			global $db;						$query = "UPDATE user_stats SET"			." last_event_user_id = '".(int)$last_event_user_id."',"			." last_event_type = '".(int)$last_event_type."',"			." last_event_data = '".(int)$last_event_data."'"			." WHERE user_id = '".(int)$user_id."'"			;			$db->query($query);					}						// ajoute des points � un utilisateur log		function addPoints($points_id, $user_id, $data = '') {			global $db;						// v�rifie si le classement du mois pr�c�dent a �t� �tabli			JL::rankingPoints();						// r�cup les infos de l'action			$query = "SELECT id, points, nb_max_par_data"			." FROM points"			." WHERE id = '".$db->escape($points_id)."'"			." LIMIT 0,1"			;			$point = $db->loadObject($query);						// si le nombre d'attributions de point est limit�			if($point->nb_max_par_data > 0) {							// check combien de fois l'utilisateur a �t� cr�dit pour cette action				$query = "SELECT COUNT(*)"				." FROM points_user"				." WHERE points_id = '".$db->escape($points_id)."' AND user_id = '".$db->escape($user_id)."' AND data LIKE '".$db->escape($data)."'"				;				$nb = (int)$db->loadResult($query);							// si le nombre de cr�dits limite a d�j� �t� attribu�				if($nb >= $point->nb_max_par_data) {					return false;				}						}						// insert le cr�dit dans la DB			$query = "INSERT INTO points_user SET"			." points_id = '".$db->escape($points_id)."',"			." user_id = '".$db->escape($user_id)."',"			." data = '".$db->escape($data)."',"			." datetime = NOW()"			;			$db->query($query);									// r�cup le nombre de points total de l'utilisateur			$query = "SELECT points_total FROM user_stats WHERE user_id = '".$db->escape($user_id)."'";			$points_total = $db->loadResult($query);						// mise � jour des stats de l'utilisateur			if($points_id == 20) { // retrait de points							$points_total_new = $points_total - (int)$data;						} else { // ajout de points							$points_total_new = $points_total + $point->points;						}						// mise � jour du total de points			$query = "UPDATE user_stats SET points_total = '".$db->escape($points_total_new)."' WHERE user_id = '".$db->escape($user_id)."'";			$db->query($query);							}						// d�termine s'il faut �tablir le classement du mois pr�c�dent. Ainsi, si le site est down le 1er du mois, le classement sera �tabli le 2. On est s�r de ne pas perdre un mois !		function rankingPoints() {			global $db;						$annee_mois = date('Y-m', mktime(0, 0, 0, date("m")-1, date("d"), date("Y")));						// r�cup un gagnant du mois pr�c�dent			$query = "SELECT id"			." FROM points_gagnants"			." WHERE annee_mois LIKE '".$db->escape($annee_mois)."'"			." LIMIT 0,1"			;			$gagnant = $db->loadResult($query);						// si le classement n'a pas �t� �tabli			if(!$gagnant) {											// variables locales				$where 		= array();				$_where		= '';												// exclue les profils helvetica media, les inactifs et suspendus				$where[]	= 'up.helvetica = 0';				$where[]	= 'u.confirmed = 1';				$where[]	= 'u.published = 1';								if (is_array($where)) {					$_where = " WHERE ".implode(" AND ", $where);				}												// r�cup les 10 premiers du classement actuel				$query = "SELECT u.id, u.username, us.points_total AS total"				." FROM user_stats AS us"				." INNER JOIN user AS u ON u.id = us.user_id"				." INNER JOIN user_profil AS up ON up.user_id = u.id"				.$_where				." ORDER BY us.points_total DESC, u.creation_date ASC"				." LIMIT 0,10"				;				$rows = $db->loadObjectList($query);								if(is_array($rows)) {									// 1�re place					if(isset($rows[0])) JL::winnerPoints($annee_mois, 1, $rows[0]);										// 2�me place					if(isset($rows[1])) JL::winnerPoints($annee_mois, 2, $rows[1]);										// 3�me place					if(isset($rows[2])) JL::winnerPoints($annee_mois, 3, $rows[2]);										// enregistre les 10 premiers du classement					foreach($rows as $row) {											$query = "INSERT INTO points_classements SET"						." user_id = '".$db->escape($row->id)."',"						." points = '".$db->escape($row->total)."',"						." annee_mois = '".$db->escape($annee_mois)."'"						;						$db->query($query);										}								}							}					}						// enregistre un gagnant		function winnerPoints($annee_mois, $position, &$row) {			global $db;						// r�cup les infos d�j� connues			$query = "SELECT nom, prenom, adresse, code_postal"			." FROM user_profil"			." WHERE user_id = '".$db->escape($row->id)."'"			." LIMIT 0,1"			;			$winner = $db->loadResult($query);						// sauvegarde le gagnant (dumoins les infos connues ou pr�sum�es)			$query = "INSERT INTO points_gagnants SET"			." annee_mois = '".$db->escape($annee_mois)."',"			." user_id = '".$db->escape($row->id)."',"			." nom = '".$db->escape($winner->nom)."',"			." prenom = '".$db->escape($winner->prenom)."',"			." adresse = '".$db->escape($winner->adresse)."',"			." code_postal = '".$db->escape($winner->code_postal)."',"			." position = '".$db->escape($position)."'"			;			$db->query($query);						// position � utiliser dans le MP			$positionTxt 	= '';			$valeurTxt		= '';			switch($position) {							case 1:					$positionTxt 	= '1�re';					$valeurTxt		= '279.90';					$gammeTxt		= 'dans la gamme � Sensations �';				break;								case 2:					$positionTxt 	= '2�me';					$valeurTxt		= '149.90';					$gammeTxt		= 'dans la gamme � Coffret Tables & Saveurs ou Maison d\'H�tes de Caract�re �';				break;								case 3:					$positionTxt 	= '3�me';					$valeurTxt		= '79.90';					$gammeTxt		= 'dans la gamme � Aventure �';				break;						}						// r�cup le MP de victoire			$query = "SELECT titre, texte"			." FROM notification"			." WHERE id = 4"			." LIMIT 0,1"			;			$mp = $db->loadObject($query);						// envoi du MP d'annonce de victoire			$query = "INSERT INTO message SET"			." user_id_from = '1',"			." user_id_to = '".$db->escape($row->id)."',"			." titre = '".$mp->titre."',"			." texte = '".$db->escape(sprintf($mp->texte, $row->username, $positionTxt, date('m/Y', mktime(0, 0, 0, date("m")-1, date("d"), date("Y"))), $gammeTxt, $valeurTxt))."',"			." date_envoi = NOW()"			;			$db->query($query);						// remise � 0 des points du gagnant			$query = "UPDATE user_stats SET points_total = 0 WHERE user_id = '".$db->escape($row->id)."'";			$db->query($query);					}				// remplace les mots cl�s du genre {texte}, {site_url}, {username}, etc...		function getMailHtml($templatePath, $titre = '', $texte = '', $username = '', $var = null) {						// r�cup le code html du template			$html		= str_replace('{texte}', 	$texte, 	file_get_contents($templatePath));						// remplace les mots cl�s			$html		= str_replace('{titre}', 	$titre, 	$html);			$html		= str_replace('{username}', $username, 	$html);			$html		= str_replace('{site_url}', SITE_URL, 	$html);						if(is_array($var)) {				$count = count($var);				for($i=0; $i<$count; $i++) $html = str_replace('{var'.($i+1).'}', $var[$i], $html);			}						return $html;				}						/* ******************************************************************************************************************************* */											// FONCTIONS ISSUES DE JOOMLA		/* ******************************************************************************************************************************* */						function makeOption($value, $text='', $value_name='value', $text_name='text') {			$obj = new stdClass;			$obj->$value_name = $value;			$obj->$text_name = trim( $text ) ? $text : $value;			return $obj;		}				/**		* Generates an HTML select list		* @param array An array of objects		* @param string The value of the HTML name attribute		* @param string Additional HTML attributes for the <select> tag		* @param string The name of the object variable for the option value		* @param string The name of the object variable for the option text		* @param mixed The key that is selected		* @returns string HTML for the select list		*/		function makeSelectList( &$arr, $tag_name, $tag_attribs, $key, $text, $selected=NULL ) {			// check if array			if ( is_array( $arr ) ) {				reset( $arr );			}			$html 	= "\n<select name=\"$tag_name\" $tag_attribs>";			$count 	= count( $arr );			for ($i=0, $n=$count; $i < $n; $i++ ) {				$k = $arr[$i]->$key;				$t = $arr[$i]->$text;				$id = ( isset($arr[$i]->id) ? @$arr[$i]->id : null);				$extra = '';				$extra .= $id ? " id=\"" . $arr[$i]->id . "\"" : '';				if (is_array( $selected )) {					foreach ($selected as $obj) {						$k2 = $obj->$key;						if ($k == $k2) {							$extra .= " selected=\"selected\"";							break;						}					}				} else {					$extra .= ($k == $selected ? " selected=\"selected\"" : '');				}				$html .= "\n\t<option value=\"".$k."\"$extra>" . makeSafe($t) . "</option>";			}			$html .= "\n</select>\n";			return $html;		}			}	?><?php		class JL {				// TODO: url rewriting		function url($url) {			return $url;		}				// retourne true si le membre est abonn�, sinon false		function checkAbonnement() {			global $user;			return ($user->gold_limit_date == '1970-01-01' || ($user->gold_limit_date != '1970-01-01' && strtotime($user->gold_limit_date) < time())) ? false : true;		}				// crypte les adresses mail et url		function messageEncode($texte, $replacement) {				    // convert support@pogoda.in		    $texte = ereg_replace('[-a-z0-9!#$%&\'*+/=?^_`{|}~.]+ *(@|\(at\)|\( at \)| \( at \) ) *([.]?[a-zA-Z0-9_/-])*', $replacement, $texte);		    // convert http://www.pogoda.in/new_york/eng/		    $texte = ereg_replace('[a-zA-Z]+://(([.]?[a-zA-Z0-9_/-])*)', $replacement, $texte);		    // convert www.pogoda.in/new_york/eng/		    $texte = ereg_replace('(www([-]*[.]?[a-zA-Z0-9_/-?&%])*)', $replacement, $texte);		   		    return $texte;					}				// ajoute des htmlentities � chaque champ d'un objet, en excluant les champs pr�sents dans la chaine $exclure		function makeSafe(&$obj, $exclure = '') {			$exclusion	= array();			if($exclure) {				$exclusion	= explode(',', $exclure);			}			if(is_object($obj)) {				foreach($obj as $k => $v) {										if(!in_array($k, $exclusion)) {						$obj->{$k} = makeSafe($v);					}				}			} elseif(is_array($obj)) {				foreach($obj as $k => $v) {					if(!in_array($k, $exclusion)) {						$obj[$k] = makeSafe($v);					}				}			}		}						// v�rifie si l'application � charger existe, et que le visiteur n'essaye pas divers hacks dans l'url avec la variable $app		function checkApp($app_load, $admin = '') {						// variables			$app_ok	= true;						// on conserve uniquement les caract�res alphanum�riques et _			$app_load_check	= preg_replace('#[^a-z0-9_]#', '', $app_load);						// d�termine si c'est une appli admin ou visiteur			if(!$admin) { // app cot� front				$path	= SITE_PATH;			} else { // app cot� back				$path	= SITE_PATH_ADMIN;			}						// si le nom de l'application n'est pas correct			if($app_load_check != $app_load) {				$app_ok	= false;			} elseif(!is_file($path.'/app/app_'.$app_load.'/'.$app_load.'.php')) { // si le chemin de l'application qui semble correcte n'existe pas				$app_ok	= false;			}						// retourne vrai si on peut charger l'application			return $app_ok;					}						// charge le corps de la page, en pr�cisant en param si c'est une appli $admin (charge par d�faut le $app)		function loadBody($admin = '') {			global $app;			JL::loadApp($app, $admin);		}						// charge l'application pass�e en param		function loadApp($app_load, $admin = '') {						// d�termine si c'est une appli admin ou visiteur			if(!$admin) { // app cot� front				$path	= SITE_PATH;			} else { // app cot� back				$path	= SITE_PATH_ADMIN;			}						// si l'application est valide			if(JL::checkApp($app_load, $admin)) {				include($path.'/app/app_'.$app_load.'/'.$app_load.'.php'); // charge l'application			} else {				echo 'Application introuvable.'; // application charg�e � la main, depuis une autre application, sinon une erreur 404 aurait �t� lev�e			}					}						// charge le module pass� en param		function loadMod($mod, $admin = '') {						// d�termine si c'est une appli admin ou visiteur			if(!$admin) { // app cot� front				$path	= SITE_PATH;			} else { // app cot� back				$path	= SITE_PATH_ADMIN;			}						if(is_file($path.'/mod/mod_'.$mod.'.php')) {				include($path.'/mod/mod_'.$mod.'.php');			} else {				echo 'Module ['.$mod.'] introuvable.';			}		}						// r�cup une variable en request		function getVar($key, $defaut, $addslashes = false) {			if($addslashes) {				return isset($_REQUEST[$key]) ? addslashes($_REQUEST[$key]) : addslashes($defaut);			} else {				return isset($_REQUEST[$key]) ? $_REQUEST[$key] : $defaut;			}		}				function cleanVar($value) {			return trim(str_replace('�', '\'', $value));		}				// ajoute une variable en request		function setVar($key, $value) {			$_REQUEST[$key]	= $value;		}						// r�cup une variable en session		function getSession($key, $defaut, $addslashes = false) {			if($addslashes) {				return isset($_SESSION[$key]) ? (!is_array($_SESSION[$key]) ? addslashes($_SESSION[$key]) : $_SESSION[$key]) : (!is_array($defaut) ? addslashes($defaut) : $defaut);			} else {				return isset($_SESSION[$key]) ? $_SESSION[$key] : $defaut;			}		}						// r�cup une variable en session, en retournant un int		function getSessionInt($key, $defaut) {			return isset($_SESSION[$key]) ? intval($_SESSION[$key]) : intval($defaut);		}						// ajoute une variable en session		function setSession($key, $value) {			$_SESSION[$key]	= $value;		}						// retourne le timestamp en microsecondes		function microtime_float() {			list($usec, $sec) = explode(" ", microtime());			return ((float)$usec + (float)$sec);		}						// d�truit compl�tement la session de l'utilisateur		function sessionDestroy() {						// d�truit toutes les variables de session			$_SESSION = array();						// d�truit le cookie de session.			if (isset($_COOKIE[session_name()])) {			    setcookie(session_name(), '', time()-42000, '/');			}						// d�truit la session.			session_destroy();					}								// envoie un mail en html		function mail($destinataire, $titre, $texte, $utf8 = true) {						// headers			$headers = 'Mime-Version: 1.0'."\r\n";			$headers = 'From: "'.SITE_MAIL_FROM.'" <'.SITE_MAIL.'>'."\r\n";			$headers .= 'Content-type: text/html; charset='.($utf8 ? 'utf-8' : 'iso-8859-1')."\r\n";			//$headers .= "\r\n";						// envoi du mail			if($utf8) {				mail($destinataire, utf8_encode($titre), utf8_encode($texte), $headers);			} else {				mail($destinataire, $titre, $texte, $headers);			}		}						// cr�e le dossier d'upload temporaire, et enregistre le nom du dossier en session		function makeUploadDir() {			global $user;						$dir_temp = 'images/profil';						if($user->id) {				$upload_dir = $user->id;			} else { 				$upload_dir = JL::getSession('upload_dir', 0);				if(!$upload_dir) {					do {						$upload_dir = JL::microtime_float()*10000;					} while(is_dir($dir_temp.'/'.$upload_dir));				}			}			JL::setSession('upload_dir', $upload_dir);						$dest_dossier	= $dir_temp.'/'.$upload_dir;			if(!is_dir($dest_dossier)) {				mkdir($dest_dossier,0777);				chmod($dest_dossier,0777);			}					}				// affichage des messages syst�me		function messages(&$messages) {						// s'il y a des messages � afficher			if (is_array($messages)) {				// pour chaque message				foreach($messages as $message) {					echo $message;				}			}					}				function redirect($url) {			if (headers_sent()) {				echo "<script>document.location.href='".JL::url($url)."';</script>\n";			} else {				@ob_end_clean();				header( 'HTTP/1.1 301 Moved Permanently' );				header( "Location: ".JL::url($url));			}			exit();		}						// retourne l'url de la photo num�ro $photo_i, de type $photo_type, de l'utilisateur $user_id		function userGetPhoto($user_id, $photo_format, $photo_type, $photo_i) {						// variables			$dir = 'images/profil/'.$user_id;						// ajout d'un s�parateur si besoin est			if($photo_type) {				$photo_type = '-'.$photo_type;			}						// photo existe			if(is_file(SITE_PATH.'/'.$dir.'/parent-solo-'.$photo_format.$photo_type.'-'.$photo_i.'.jpg')) {								return SITE_URL.'/'.$dir.'/parent-solo-'.$photo_format.$photo_type.'-'.$photo_i.'.jpg';							} else { // photo n'existe pas								// test sur les 6 photos				for($i=1;$i<=6;$i++) {					if(is_file(SITE_PATH.'/'.$dir.'/parent-solo-'.$photo_format.$photo_type.'-'.$i.'.jpg')) {												// retourne la premi�re photo trouv�e						return SITE_URL.'/'.$dir.'/parent-solo-'.$photo_format.$photo_type.'-'.$i.'.jpg';											}				}								return false;							}					}						function notificationBasique($type = 'visite', $profil_id) {include("lang/app_framework.".$_GET['lang'].".php");			global $db, $user;						// variables			$titre	= array(				'visite' 	=> $user->username." ".$lang_framework['AConsulteVotre']."",				'message' 	=> $user->username." ".$lang_framework['VousAEnvoyeMessage']."",				'fleur' 	=> $user->username." ".$lang_framework['VousAEnvoyeFleur'].""			);						$intro	= array(				'visite' 	=> "".$lang_framework['VousAvezVisite']." !",				'message' 	=> "".$lang_framework['VousAvezMessage']." !",				'fleur' 	=> "".$lang_framework['VousAvezFleur']." !"			);						$texte	= array(				'visite' 	=> "".$lang_framework['VousPouvezAussi']." \n<br /><a href='".JL::url(SITE_URL.'/index.php?app=profil&action=view&id='.$user->id.'&'.$langue)."'>".$lang_framework['ConsulterSonProfil']."</a>...<br /><br /> ".$lang_framework['EtPourquoiPas']." <br /><a href='".JL::url(SITE_URL.'/index.php?app=message&action=write&user_to='.$user->username.'&'.$langue)."'>".$lang_framework['EnvyerUnMessage']."</a> ?",				'message' 	=> "".$lang_framework['VousPouvezAussi']." \n<br />lui <a href='".JL::url(SITE_URL.'/index.php?app=message&action=write&user_to='.$user->username.'&'.$langue)."'>".$lang_framework['EnvoyerUnMessage']."</a>...<br /><br /> ".$lang_framework['EtPourquoiPas']." <br /><a href='".JL::url(SITE_URL.'/index.php?app=profil&action=view&id='.$user->id.'&'.$langue)."'>".$lang_framework['ConsulterSonProfil']."</a> ?",				'fleur' 	=> "".$lang_framework['VousPouvezAussi']." \n<br />lui <a href='".JL::url(SITE_URL.'/index.php?app=message&action=flower&user_to='.$user->username.'&'.$langue)."'>".$lang_framework['EnvoyerUneFleur']."</a>...<br /><br /> ".$lang_framework['EtPourquoiPas']." <br /><a href='".JL::url(SITE_URL.'/index.php?app=profil&action=view&id='.$user->id.'&'.$langue)."'>".$lang_framework['ConsulterSonProfil']."</a> ?"			);						$icone	= array(				'visite' 	=> 'icone-visite.jpg',				'message' 	=> 'icone-message.jpg',				'fleur' 	=> 'icone-fleur.jpg'			);						// r�cup les infos du profil			$query = "SELECT u.id, u.username, u.email, up.genre, up.photo_defaut, un.new_".$type			." FROM user AS u"			." INNER JOIN user_profil AS up ON up.user_id = u.id"			." INNER JOIN user_notification AS un ON un.user_id = u.id"			." WHERE u.id = '".$profil_id."'"			." LIMIT 0,1"			;			$profil = $db->loadObject($query);						if((int)$profil->{'new_'.$type}) {								// r�cup les infos de l'utilisateur log				$query = "SELECT up.photo_defaut, IFNULL(pc.nom, '') AS canton, up.nb_enfants, up.genre, CURRENT_DATE, (YEAR(CURRENT_DATE)-YEAR(up.naissance_date)) - (RIGHT(CURRENT_DATE,5)<RIGHT(up.naissance_date,5)) AS age"				." FROM user AS u"				." INNER JOIN user_profil AS up ON up.user_id = u.id"				." LEFT JOIN profil_canton AS pc ON pc.id = up.canton_id"				." WHERE up.user_id = '".$user->id."'"				." LIMIT 0,1"				;				$userLog = $db->loadObject($query);								// r�cup la photo par d�faut du profil				$photoDefautProfil 	= JL::userGetPhoto($profil->id, 'preview', 'profil', $profil->photo_defaut);				if(!$photoDefautProfil) {					$photoDefautProfil = SITE_URL.'/parentsolo/images/parent-solo-preview-'.$profil->genre.'.jpg';				}							// r�cup la photo par d�faut de l'utilisateur log				$photoDefautUser 	= JL::userGetPhoto($user->id, 'mini', 'profil', $userLog->photo_defaut);				if(!$photoDefautUser) {					$photoDefautUser = SITE_URL.'/parentsolo/images/profil-parentsolo-'.$userLog->genre.'.jpg';				}								// r�cup les stats du compte				$query = "SELECT visite_total, fleur_new, message_new, CURRENT_DATE, IF(gold_limit_date > CURRENT_DATE, 1, 0) AS gold, gold_limit_date"				." FROM user_stats"				." WHERE user_id = '".$profil->id."'"				." LIMIT 0,1"				;				$userStats = $db->loadObject($query);									<html>gUrl	= SITE_URL."/images/mail";				$sujet 	= "SoloCircl.com - ".$titre[$type];				$headers ='From: "'.SITE_MAIL_FROM.'" <'.SITE_MAIL.'>'."\n";				$headers .='Reply-To: '.SITE_MAIL."\n";				$headers .='Content-Type: text/html; charset="iso-8859-1"'."\n";				$headers .='Content-Transfer-Encoding: 8bit';				$message ="<html><head><title>".makeSafe($sujet)."</title></head>\n"				."<body style='background-color:rgb(0,0,0);'>\n"				."<div style='padding: 20px;background-color:\n rgb(0, 0, 0);color:rgb(255, 255, 255);'>\n"				."<table style='font-family:Verdana;'>\n"								."<tr><td style='width:217px;height:171px;'><a href='".SITE_URL."."?".$langue'>\n<img src='".$imgUrl."/logo.jpg' border='0' /></a></td>\n"				."<td style='width:92px;height:97px;padding:74px 0px 0px 108px;vertical-align:top;\n background-image:url(".$imgUrl."/photo.jpg);'\n background='".$imgUrl."/photo.jpg'>\n"				."<img src='".$photoDefautProfil."' border='0' /></td>\n"				."<td style='width:293px;height:111px;color:rgb(255,255,255);\n background-color:rgb(0,0,0);padding:60px 0px 0px 10px;font-size:12px;'>\n<b>".$profil->username."</b><br />\n"				."".$lang_framework['VousAvezRecu']." <span style='color:rgb(205,1,114);font-weight:bold;'>\n".$userStats->visite_total."</span> ".($userStats->visite_total > 1 ? ''.$lang_framework["Visites"].'' : ''.$lang_framework["Visite"].'').".<br />\n"				."".$lang_framework['VousAvez']." <span style='color:rgb(205,1,114);font-weight:bold;'>\n".$userStats->message_new."</span> ".($userStats->message_new > 1 ? ''.$lang_framework["Nouveaux"].'' : ''.$lang_framework["Nouveau"].'')." ".($userStats->message_new > 1 ? ''.$lang_framework["Messages"].'' : ''.$lang_framework["Message"].'').".<br />\n"				."".$lang_framework['VousAvez']." <span style='color:rgb(205,1,114);font-weight:bold;'>\n".$userStats->fleur_new."</span> ".($userStats->fleur_new > 1 ? ''.$lang_framework["Nouvelles"].'' : ''.$lang_framework["Nouvelle"].'')." ".($userStats->fleur_new > 1 ? ''.$lang_framework["Fleurs"].'' : ''.$lang_framework["Fleur"].'').".<br />\n"				."<span style='background-color:rgb(255,153,204);display:block;width:210px;\n text-align:left;font-size:12px;margin:2px 0px 0px 0px;\n padding:2px 5px 2px 5px;color:rgb(0,0,0);'>".($userStats->gold ? "<b>".$lang_framework['FinAbonnement'].":</b>\n&nbsp;<span style='color:rgb(205,1,114);font-weight:bold;'>\n".date('d/m/y', strtotime($userStats->gold_limit_date))."</span>" : "<b>".$lang_framework['Membre'].":</b> <a href='".JL::url(SITE_URL.'/index.php?app=abonnement&action=tarifs'.'&'.$langue)."'\n style='color:rgb(205,1,114);font-weight:bold;'>".$lang_framework['AbonnezVous']." !</a>")."</span></td></tr>\n"								."<tr><td colspan='3' style='width:720px;height:429px;\n background-image:url(".$imgUrl."/bg.jpg);\n vertical-align:top;'\n background='".$imgUrl."/bg.jpg'>\n"								."<span style='display:block;padding:20px 0px 0px 20px;height:20px;\n color:rgb(255,153,51);font-size:18px;font-weight:bold;'>\n".$intro[$type]."</span>\n"								."<div style='padding:60px 0px 0px 20px;'>\n"				."<table style='font-family:Verdana;'><tr><td style='width:105px;height:164px;padding:0px;\n background-image:url(".$imgUrl."/profil.gif);\n vertical-align:top;background-repeat:no-repeat;'\n background='".$imgUrl."/profil.gif' valign='top'>\n<div style='height:20px;line-height:20px;\n font-size:12px;color:rgb(255,255,255);padding:2px 0px 0px 5px;'>".$user->username."</div>\n<div style='height:100px;padding: 0px 0px 0px 2px'>\n<img src='".$photoDefautUser."' border='0' />\n<div style='padding:1px 4px 0px 4px;color:rgb(0,0,0);font-size:11px;line-height: 12px;'>\n	".$userLog->age." ".$lang_framework['Ans']."<br />".$userLog->nb_enfants." ".($userLog->nb_enfants > 1 ? ''.$lang_framework["Enfants"].'' : ''.$lang_framework["Enfant"].'')."<br />\n".makeSafe($userLog->canton)."</div></td>\n"								."<td style='font-size:14px;font-weight:bold;\n background-image:url(".$imgUrl."/box.jpg);\n color:rgb(205,1,114);\n text-align:center;vertical-align:middle;width:339px;\n height:164px;padding:0px 20px 0px 20px;'\n background='".$imgUrl."/box.jpg'>\n"				.$titre[$type]." !\n<br /><br />".$texte[$type]."</td>\n"								."<td style='width:120px;height:164px;vertical-align:top;padding:0px;' valign='top'><a href='".JL::url(SITE_URL.'/index.php?app=message&action=flower&user_to='.$user->username.'&'.$langue)."'\n style='display:block;width:119px;height:32px;margin:0px;padding:0px;'><img\n src='".$imgUrl."/rose2.jpg' border='0' /></a><img\n src='".$imgUrl."/".$icone[$type]."' style='display:block;margin:0px;padding:0px;width:119px;height:100px;' /><a\n href='".JL::url(SITE_URL.'/index.php?app=message&action=write&user_to='.$user->username)."'\n style='display:block;width:119px;height:29px;margin:0px;padding:0px;'><img\n src='".$imgUrl."/message2.jpg' border='0' /></a></td></tr></table></div>\n"								."<span style='font-family:Verdana;display:block;padding:80px 0px 0px 20px;width:570px;\n color:rgb(55,55,55);\n font-size:11px;font-style:italic;'>\n".$lang_framework['SiVousNeSouhaitz'].".</span>\n"								."</td></tr>\n"								."</table></div></body></html>"				;				mail($profil->email, $sujet, $message, $headers);							}					}						// conserve le dernier �v�nement effectu� sur un profil		function addLastEvent($user_id = 0, $last_event_user_id = 0, $last_event_type = 0, $last_event_data = 0) {			global $db;						$query = "UPDATE user_stats SET"			." last_event_user_id = '".(int)$last_event_user_id."',"			." last_event_type = '".(int)$last_event_type."',"			." last_event_data = '".(int)$last_event_data."'"			." WHERE user_id = '".(int)$user_id."'"			;			$db->query($query);					}						// ajoute des points � un utilisateur log		function addPoints($points_id, $user_id, $data = '') {			global $db;						// v�rifie si le classement du mois pr�c�dent a �t� �tabli			JL::rankingPoints();						// r�cup les infos de l'action			$query = "SELECT id, points, nb_max_par_data"			." FROM points"			." WHERE id = '".$db->escape($points_id)."'"			." LIMIT 0,1"			;			$point = $db->loadObject($query);						// si le nombre d'attributions de point est limit�			if($point->nb_max_par_data > 0) {							// check combien de fois l'utilisateur a �t� cr�dit pour cette action				$query = "SELECT COUNT(*)"				." FROM points_user"				." WHERE points_id = '".$db->escape($points_id)."' AND user_id = '".$db->escape($user_id)."' AND data LIKE '".$db->escape($data)."'"				;				$nb = (int)$db->loadResult($query);							// si le nombre de cr�dits limite a d�j� �t� attribu�				if($nb >= $point->nb_max_par_data) {					return false;				}						}						// insert le cr�dit dans la DB			$query = "INSERT INTO points_user SET"			." points_id = '".$db->escape($points_id)."',"			." user_id = '".$db->escape($user_id)."',"			." data = '".$db->escape($data)."',"			." datetime = NOW()"			;			$db->query($query);									// r�cup le nombre de points total de l'utilisateur			$query = "SELECT points_total FROM user_stats WHERE user_id = '".$db->escape($user_id)."'";			$points_total = $db->loadResult($query);						// mise � jour des stats de l'utilisateur			if($points_id == 20) { // retrait de points							$points_total_new = $points_total - (int)$data;						} else { // ajout de points							$points_total_new = $points_total + $point->points;						}						// mise � jour du total de points			$query = "UPDATE user_stats SET points_total = '".$db->escape($points_total_new)."' WHERE user_id = '".$db->escape($user_id)."'";			$db->query($query);							}						// d�termine s'il faut �tablir le classement du mois pr�c�dent. Ainsi, si le site est down le 1er du mois, le classement sera �tabli le 2. On est s�r de ne pas perdre un mois !		function rankingPoints() {			global $db;						$annee_mois = date('Y-m', mktime(0, 0, 0, date("m")-1, date("d"), date("Y")));						// r�cup un gagnant du mois pr�c�dent			$query = "SELECT id"			." FROM points_gagnants"			." WHERE annee_mois LIKE '".$db->escape($annee_mois)."'"			." LIMIT 0,1"			;			$gagnant = $db->loadResult($query);						// si le classement n'a pas �t� �tabli			if(!$gagnant) {											// variables locales				$where 		= array();				$_where		= '';												// exclue les profils helvetica media, les inactifs et suspendus				$where[]	= 'up.helvetica = 0';				$where[]	= 'u.confirmed = 1';				$where[]	= 'u.published = 1';								if (is_array($where)) {					$_where = " WHERE ".implode(" AND ", $where);				}												// r�cup les 10 premiers du classement actuel				$query = "SELECT u.id, u.username, us.points_total AS total"				." FROM user_stats AS us"				." INNER JOIN user AS u ON u.id = us.user_id"				." INNER JOIN user_profil AS up ON up.user_id = u.id"				.$_where				." ORDER BY us.points_total DESC, u.creation_date ASC"				." LIMIT 0,10"				;				$rows = $db->loadObjectList($query);								if(is_array($rows)) {									// 1�re place					if(isset($rows[0])) JL::winnerPoints($annee_mois, 1, $rows[0]);										// 2�me place					if(isset($rows[1])) JL::winnerPoints($annee_mois, 2, $rows[1]);										// 3�me place					if(isset($rows[2])) JL::winnerPoints($annee_mois, 3, $rows[2]);										// enregistre les 10 premiers du classement					foreach($rows as $row) {											$query = "INSERT INTO points_classements SET"						." user_id = '".$db->escape($row->id)."',"						." points = '".$db->escape($row->total)."',"						." annee_mois = '".$db->escape($annee_mois)."'"						;						$db->query($query);										}								}							}					}						// enregistre un gagnant		function winnerPoints($annee_mois, $position, &$row) {include("lang/app_framework.".$_GET['lang'].".php");			global $db;						// r�cup les infos d�j� connues			$query = "SELECT nom, prenom, adresse, code_postal"			." FROM user_profil"			." WHERE user_id = '".$db->escape($row->id)."'"			." LIMIT 0,1"			;			$winner = $db->loadResult($query);						// sauvegarde le gagnant (dumoins les infos connues ou pr�sum�es)			$query = "INSERT INTO points_gagnants SET"			." annee_mois = '".$db->escape($annee_mois)."',"			." user_id = '".$db->escape($row->id)."',"			." nom = '".$db->escape($winner->nom)."',"			." prenom = '".$db->escape($winner->prenom)."',"			." adresse = '".$db->escape($winner->adresse)."',"			." code_postal = '".$db->escape($winner->code_postal)."',"			." position = '".$db->escape($position)."'"			;			$db->query($query);						// position � utiliser dans le MP			$positionTxt 	= '';			$valeurTxt		= '';			switch($position) {							case 1:					$positionTxt 	= ''.$lang_framework["Ere1"].'';					$valeurTxt		= '279.90';					$gammeTxt		= ''.$lang_framework["DansLaGammeSensation"].'';				break;								case 2:					$positionTxt 	= ''.$lang_framework["Eme2"].'';					$valeurTxt		= '149.90';					$gammeTxt		= ''.$lang_framework["DansLaGammeCoffret"].'';				break;								case 3:					$positionTxt 	= ''.$lang_framework["Eme3"].'';					$valeurTxt		= '79.90';					$gammeTxt		= ''.$lang_framework["DansLaGammeAventure"].'';				break;						}						// r�cup le MP de victoire			$query = "SELECT titre, texte"			." FROM notification"			." WHERE id = 4"			." LIMIT 0,1"			;			$mp = $db->loadObject($query);						// envoi du MP d'annonce de victoire			$query = "INSERT INTO message SET"			." user_id_from = '1',"			." user_id_to = '".$db->escape($row->id)."',"			." titre = '".$mp->titre."',"			." texte = '".$db->escape(sprintf($mp->texte, $row->username, $positionTxt, date('m/Y', mktime(0, 0, 0, date("m")-1, date("d"), date("Y"))), $gammeTxt, $valeurTxt))."',"			." date_envoi = NOW()"			;			$db->query($query);						// remise � 0 des points du gagnant			$query = "UPDATE user_stats SET points_total = 0 WHERE user_id = '".$db->escape($row->id)."'";			$db->query($query);					}				// remplace les mots cl�s du genre {texte}, {site_url}, {username}, etc...		function getMailHtml($templatePath, $titre = '', $texte = '', $username = '', $var = null) {						// r�cup le code html du template			$html		= str_replace('{texte}', 	$texte, 	file_get_contents($templatePath));						// remplace les mots cl�s			$html		= str_replace('{titre}', 	$titre, 	$html);			$html		= str_replace('{username}', $username, 	$html);			$html		= str_replace('{site_url}', SITE_URL, 	$html);						if(is_array($var)) {				$count = count($var);				for($i=0; $i<$count; $i++) $html = str_replace('{var'.($i+1).'}', $var[$i], $html);			}						return $html;				}						/* ******************************************************************************************************************************* */											// FONCTIONS ISSUES DE JOOMLA		/* ******************************************************************************************************************************* */						function makeOption($value, $text='', $value_name='value', $text_name='text') {			$obj = new stdClass;			$obj->$value_name = $value;			$obj->$text_name = trim( $text ) ? $text : $value;			return $obj;		}				/**		* Generates an HTML select list		* @param array An array of objects		* @param string The value of the HTML name attribute		* @param string Additional HTML attributes for the <select> tag		* @param string The name of the object variable for the option value		* @param string The name of the object variable for the option text		* @param mixed The key that is selected		* @returns string HTML for the select list		*/		function makeSelectList( &$arr, $tag_name, $tag_attribs, $key, $text, $selected=NULL ) {			// check if array			if ( is_array( $arr ) ) {				reset( $arr );			}			$html 	= "\n<select name=\"$tag_name\" $tag_attribs>";			$count 	= count( $arr );			for ($i=0, $n=$count; $i < $n; $i++ ) {				$k = $arr[$i]->$key;				$t = $arr[$i]->$text;				$id = ( isset($arr[$i]->id) ? @$arr[$i]->id : null);				$extra = '';				$extra .= $id ? " id=\"" . $arr[$i]->id . "\"" : '';				if (is_array( $selected )) {					foreach ($selected as $obj) {						$k2 = $obj->$key;						if ($k == $k2) {							$extra .= " selected=\"selected\"";							break;						}					}				} else {					$extra .= ($k == $selected ? " selected=\"selected\"" : '');				}				$html .= "\n\t<option value=\"".$k."\"$extra>" . makeSafe($t) . "</option>";			}			$html .= "\n</select>\n";			return $html;		}			}	?><?php		class JL {				// TODO: url rewriting		function url($url) {			return $url;		}				// retourne true si le membre est abonn�, sinon false		function checkAbonnement() {			global $user;			return ($user->gold_limit_date == '1970-01-01' || ($user->gold_limit_date != '1970-01-01' && strtotime($user->gold_limit_date) < time())) ? false : true;		}				// crypte les adresses mail et url		function messageEncode($texte, $replacement) {				    // convert support@pogoda.in		    $texte = ereg_replace('[-a-z0-9!#$%&\'*+/=?^_`{|}~.]+ *(@|\(at\)|\( at \)| \( at \) ) *([.]?[a-zA-Z0-9_/-])*', $replacement, $texte);		    // convert http://www.pogoda.in/new_york/eng/		    $texte = ereg_replace('[a-zA-Z]+://(([.]?[a-zA-Z0-9_/-])*)', $replacement, $texte);		    // convert www.pogoda.in/new_york/eng/		    $texte = ereg_replace('(www([-]*[.]?[a-zA-Z0-9_/-?&%])*)', $replacement, $texte);		   		    return $texte;					}				// ajoute des htmlentities � chaque champ d'un objet, en excluant les champs pr�sents dans la chaine $exclure		function makeSafe(&$obj, $exclure = '') {			$exclusion	= array();			if($exclure) {				$exclusion	= explode(',', $exclure);			}			if(is_object($obj)) {				foreach($obj as $k => $v) {										if(!in_array($k, $exclusion)) {						$obj->{$k} = makeSafe($v);					}				}			} elseif(is_array($obj)) {				foreach($obj as $k => $v) {					if(!in_array($k, $exclusion)) {						$obj[$k] = makeSafe($v);					}				}			}		}						// v�rifie si l'application � charger existe, et que le visiteur n'essaye pas divers hacks dans l'url avec la variable $app		function checkApp($app_load, $admin = '') {						// variables			$app_ok	= true;						// on conserve uniquement les caract�res alphanum�riques et _			$app_load_check	= preg_replace('#[^a-z0-9_]#', '', $app_load);						// d�termine si c'est une appli admin ou visiteur			if(!$admin) { // app cot� front				$path	= SITE_PATH;			} else { // app cot� back				$path	= SITE_PATH_ADMIN;			}						// si le nom de l'application n'est pas correct			if($app_load_check != $app_load) {				$app_ok	= false;			} elseif(!is_file($path.'/app/app_'.$app_load.'/'.$app_load.'.php')) { // si le chemin de l'application qui semble correcte n'existe pas				$app_ok	= false;			}						// retourne vrai si on peut charger l'application			return $app_ok;					}						// charge le corps de la page, en pr�cisant en param si c'est une appli $admin (charge par d�faut le $app)		function loadBody($admin = '') {			global $app;			JL::loadApp($app, $admin);		}						// charge l'application pass�e en param		function loadApp($app_load, $admin = '') {						// d�termine si c'est une appli admin ou visiteur			if(!$admin) { // app cot� front				$path	= SITE_PATH;			} else { // app cot� back				$path	= SITE_PATH_ADMIN;			}						// si l'application est valide			if(JL::checkApp($app_load, $admin)) {				include($path.'/app/app_'.$app_load.'/'.$app_load.'.php'); // charge l'application			} else {				echo 'Application introuvable.'; // application charg�e � la main, depuis une autre application, sinon une erreur 404 aurait �t� lev�e			}					}						// charge le module pass� en param		function loadMod($mod, $admin = '') {						// d�termine si c'est une appli admin ou visiteur			if(!$admin) { // app cot� front				$path	= SITE_PATH;			} else { // app cot� back				$path	= SITE_PATH_ADMIN;			}						if(is_file($path.'/mod/mod_'.$mod.'.php')) {				include($path.'/mod/mod_'.$mod.'.php');			} else {				echo 'Module ['.$mod.'] introuvable.';			}		}						// r�cup une variable en request		function getVar($key, $defaut, $addslashes = false) {			if($addslashes) {				return isset($_REQUEST[$key]) ? addslashes($_REQUEST[$key]) : addslashes($defaut);			} else {				return isset($_REQUEST[$key]) ? $_REQUEST[$key] : $defaut;			}		}				function cleanVar($value) {			return trim(str_replace('�', '\'', $value));		}				// ajoute une variable en request		function setVar($key, $value) {			$_REQUEST[$key]	= $value;		}						// r�cup une variable en session		function getSession($key, $defaut, $addslashes = false) {			if($addslashes) {				return isset($_SESSION[$key]) ? (!is_array($_SESSION[$key]) ? addslashes($_SESSION[$key]) : $_SESSION[$key]) : (!is_array($defaut) ? addslashes($defaut) : $defaut);			} else {				return isset($_SESSION[$key]) ? $_SESSION[$key] : $defaut;			}		}						// r�cup une variable en session, en retournant un int		function getSessionInt($key, $defaut) {			return isset($_SESSION[$key]) ? intval($_SESSION[$key]) : intval($defaut);		}						// ajoute une variable en session		function setSession($key, $value) {			$_SESSION[$key]	= $value;		}						// retourne le timestamp en microsecondes		function microtime_float() {			list($usec, $sec) = explode(" ", microtime());			return ((float)$usec + (float)$sec);		}						// d�truit compl�tement la session de l'utilisateur		function sessionDestroy() {						// d�truit toutes les variables de session			$_SESSION = array();						// d�truit le cookie de session.			if (isset($_COOKIE[session_name()])) {			    setcookie(session_name(), '', time()-42000, '/');			}						// d�truit la session.			session_destroy();					}								// envoie un mail en html		function mail($destinataire, $titre, $texte, $utf8 = true) {						// headers			$headers = 'Mime-Version: 1.0'."\r\n";			$headers = 'From: "'.SITE_MAIL_FROM.'" <'.SITE_MAIL.'>'."\r\n";			$headers .= 'Content-type: text/html; charset='.($utf8 ? 'utf-8' : 'iso-8859-1')."\r\n";			//$headers .= "\r\n";						// envoi du mail			if($utf8) {				mail($destinataire, utf8_encode($titre), utf8_encode($texte), $headers);			} else {				mail($destinataire, $titre, $texte, $headers);			}		}						// cr�e le dossier d'upload temporaire, et enregistre le nom du dossier en session		function makeUploadDir() {			global $user;						$dir_temp = 'images/profil';						if($user->id) {				$upload_dir = $user->id;			} else { 				$upload_dir = JL::getSession('upload_dir', 0);				if(!$upload_dir) {					do {						$upload_dir = JL::microtime_float()*10000;					} while(is_dir($dir_temp.'/'.$upload_dir));				}			}			JL::setSession('upload_dir', $upload_dir);						$dest_dossier	= $dir_temp.'/'.$upload_dir;			if(!is_dir($dest_dossier)) {				mkdir($dest_dossier,0777);				chmod($dest_dossier,0777);			}					}				// affichage des messages syst�me		function messages(&$messages) {						// s'il y a des messages � afficher			if (is_array($messages)) {				// pour chaque message				foreach($messages as $message) {					echo $message;				}			}					}				function redirect($url) {			if (headers_sent()) {				echo "<script>document.location.href='".JL::url($url)."';</script>\n";			} else {				@ob_end_clean();				header( 'HTTP/1.1 301 Moved Permanently' );				header( "Location: ".JL::url($url));			}			exit();		}						// retourne l'url de la photo num�ro $photo_i, de type $photo_type, de l'utilisateur $user_id		function userGetPhoto($user_id, $photo_format, $photo_type, $photo_i) {						// variables			$dir = 'images/profil/'.$user_id;						// ajout d'un s�parateur si besoin est			if($photo_type) {				$photo_type = '-'.$photo_type;			}						// photo existe			if(is_file(SITE_PATH.'/'.$dir.'/parent-solo-'.$photo_format.$photo_type.'-'.$photo_i.'.jpg')) {								return SITE_URL.'/'.$dir.'/parent-solo-'.$photo_format.$photo_type.'-'.$photo_i.'.jpg';							} else { // photo n'existe pas								// test sur les 6 photos				for($i=1;$i<=6;$i++) {					if(is_file(SITE_PATH.'/'.$dir.'/parent-solo-'.$photo_format.$photo_type.'-'.$i.'.jpg')) {												// retourne la premi�re photo trouv�e						return SITE_URL.'/'.$dir.'/parent-solo-'.$photo_format.$photo_type.'-'.$i.'.jpg';											}				}								return false;							}					}						function notificationBasique($type = 'visite', $profil_id) {include("lang/app_framework.".$_GET['lang'].".php");			global $db, $user;						// variables			$titre	= array(				'visite' 	=> $user->username." ".$lang_framework['AConsulteVotre']."",				'message' 	=> $user->username." ".$lang_framework['VousAEnvoyeMessage']."",				'fleur' 	=> $user->username." ".$lang_framework['VousAEnvoyeFleur'].""			);						$intro	= array(				'visite' 	=> "".$lang_framework['VousAvezVisite']." !",				'message' 	=> "".$lang_framework['VousAvezMessage']." !",				'fleur' 	=> "".$lang_framework['VousAvezFleur']." !"			);						$texte	= array(				'visite' 	=> "".$lang_framework['VousPouvezAussi']." \n<br /><a href='".JL::url(SITE_URL.'/index.php?app=profil&action=view&id='.$user->id.'&'.$langue)."'>".$lang_framework['ConsulterSonProfil']."</a>...<br /><br /> ".$lang_framework['EtPourquoiPas']." <br /><a href='".JL::url(SITE_URL.'/index.php?app=message&action=write&user_to='.$user->username.'&'.$langue)."'>".$lang_framework['EnvyerUnMessage']."</a> ?",				'message' 	=> "".$lang_framework['VousPouvezAussi']." \n<br />lui <a href='".JL::url(SITE_URL.'/index.php?app=message&action=write&user_to='.$user->username.'&'.$langue)."'>".$lang_framework['EnvoyerUnMessage']."</a>...<br /><br /> ".$lang_framework['EtPourquoiPas']." <br /><a href='".JL::url(SITE_URL.'/index.php?app=profil&action=view&id='.$user->id.'&'.$langue)."'>".$lang_framework['ConsulterSonProfil']."</a> ?",				'fleur' 	=> "".$lang_framework['VousPouvezAussi']." \n<br />lui <a href='".JL::url(SITE_URL.'/index.php?app=message&action=flower&user_to='.$user->username.'&'.$langue)."'>".$lang_framework['EnvoyerUneFleur']."</a>...<br /><br /> ".$lang_framework['EtPourquoiPas']." <br /><a href='".JL::url(SITE_URL.'/index.php?app=profil&action=view&id='.$user->id.'&'.$langue)."'>".$lang_framework['ConsulterSonProfil']."</a> ?"			);						$icone	= array(				'visite' 	=> 'icone-visite.jpg',				'message' 	=> 'icone-message.jpg',				'fleur' 	=> 'icone-fleur.jpg'			);						// r�cup les infos du profil			$query = "SELECT u.id, u.username, u.email, up.genre, up.photo_defaut, un.new_".$type			." FROM user AS u"			." INNER JOIN user_profil AS up ON up.user_id = u.id"			." INNER JOIN user_notification AS un ON un.user_id = u.id"			." WHERE u.id = '".$profil_id."'"			." LIMIT 0,1"			;			$profil = $db->loadObject($query);						if((int)$profil->{'new_'.$type}) {								// r�cup les infos de l'utilisateur log				$query = "SELECT up.photo_defaut, IFNULL(pc.nom, '') AS canton, up.nb_enfants, up.genre, CURRENT_DATE, (YEAR(CURRENT_DATE)-YEAR(up.naissance_date)) - (RIGHT(CURRENT_DATE,5)<RIGHT(up.naissance_date,5)) AS age"				." FROM user AS u"				." INNER JOIN user_profil AS up ON up.user_id = u.id"				." LEFT JOIN profil_canton AS pc ON pc.id = up.canton_id"				." WHERE up.user_id = '".$user->id."'"				." LIMIT 0,1"				;				$userLog = $db->loadObject($query);								// r�cup la photo par d�faut du profil				$photoDefautProfil 	= JL::userGetPhoto($profil->id, 'preview', 'profil', $profil->photo_defaut);				if(!$photoDefautProfil) {					$photoDefautProfil = SITE_URL.'/parentsolo/images/parent-solo-preview-'.$profil->genre.'.jpg';				}							// r�cup la photo par d�faut de l'utilisateur log				$photoDefautUser 	= JL::userGetPhoto($user->id, 'mini', 'profil', $userLog->photo_defaut);				if(!$photoDefautUser) {					$photoDefautUser = SITE_URL.'/parentsolo/images/profil-parentsolo-'.$userLog->genre.'.jpg';				}								// r�cup les stats du compte				$query = "SELECT visite_total, fleur_new, message_new, CURRENT_DATE, IF<html>limit_date > CURRENT_DATE, 1, 0) AS gold, gold_limit_date"				." FROM user_stats"				." WHERE user_id = '".$profil->id."'"				." LIMIT 0,1"				;				$userStats = $db->loadObject($query);												$imgUrl	= SITE_URL."/images/mail";				$sujet 	= "SoloCircl.com - ".$titre[$type];				$headers ='From: "'.SITE_MAIL_FROM.'" <'.SITE_MAIL.'>'."\n";				$headers .='Reply-To: '.SITE_MAIL."\n";				$headers .='Content-Type: text/html; charset="iso-8859-1"'."\n";				$headers .='Content-Transfer-Encoding: 8bit';				$message ="<html><head><title>".makeSafe($sujet)."</title></head>\n"				."<body style='background-color:rgb(0,0,0);'>\n"				."<div style='padding: 20px;background-color:\n rgb(0, 0, 0);color:rgb(255, 255, 255);'>\n"				."<table style='font-family:Verdana;'>\n"								."<tr><td style='width:217px;height:171px;'><a href='".SITE_URL."?".$langue."'>\n<img src='".$imgUrl."/logo.jpg' border='0' /></a></td>\n"				."<td style='width:92px;height:97px;padding:74px 0px 0px 108px;vertical-align:top;\n background-image:url(".$imgUrl."/photo.jpg);'\n background='".$imgUrl."/photo.jpg'>\n"				."<img src='".$photoDefautProfil."' border='0' /></td>\n"				."<td style='width:293px;height:111px;color:rgb(255,255,255);\n background-color:rgb(0,0,0);padding:60px 0px 0px 10px;font-size:12px;'>\n<b>".$profil->username."</b><br />\n"				."".$lang_framework['VousAvezRecu']." <span style='color:rgb(205,1,114);font-weight:bold;'>\n".$userStats->visite_total."</span> ".($userStats->visite_total > 1 ? ''.$lang_framework["Visites"].'' : ''.$lang_framework["Visite"].'').".<br />\n"				."".$lang_framework['VousAvez']." <span style='color:rgb(205,1,114);font-weight:bold;'>\n".$userStats->message_new."</span> ".($userStats->message_new > 1 ? ''.$lang_framework["Nouveaux"].'' : ''.$lang_framework["Nouveau"].'')." ".($userStats->message_new > 1 ? ''.$lang_framework["Messages"].'' : ''.$lang_framework["Message"].'').".<br />\n"				."".$lang_framework['VousAvez']." <span style='color:rgb(205,1,114);font-weight:bold;'>\n".$userStats->fleur_new."</span> ".($userStats->fleur_new > 1 ? ''.$lang_framework["Nouvelles"].'' : ''.$lang_framework["Nouvelle"].'')." ".($userStats->fleur_new > 1 ? ''.$lang_framework["Fleurs"].'' : ''.$lang_framework["Fleur"].'').".<br />\n"				."<span style='background-color:rgb(255,153,204);display:block;width:210px;\n text-align:left;font-size:12px;margin:2px 0px 0px 0px;\n padding:2px 5px 2px 5px;color:rgb(0,0,0);'>".($userStats->gold ? "<b>".$lang_framework['FinAbonnement'].":</b>\n&nbsp;<span style='color:rgb(205,1,114);font-weight:bold;'>\n".date('d/m/y', strtotime($userStats->gold_limit_date))."</span>" : "<b>".$lang_framework['Membre'].":</b> <a href='".JL::url(SITE_URL.'/index.php?app=abonnement&action=tarifs'.'&'.$langue)."'\n style='color:rgb(205,1,114);font-weight:bold;'>".$lang_framework['AbonnezVous']." !</a>")."</span></td></tr>\n"								."<tr><td colspan='3' style='width:720px;height:429px;\n background-image:url(".$imgUrl."/bg.jpg);\n vertical-align:top;'\n background='".$imgUrl."/bg.jpg'>\n"								."<span style='display:block;padding:20px 0px 0px 20px;height:20px;\n color:rgb(255,153,51);font-size:18px;font-weight:bold;'>\n".$intro[$type]."</span>\n"								."<div style='padding:60px 0px 0px 20px;'>\n"				."<table style='font-family:Verdana;'><tr><td style='width:105px;height:164px;padding:0px;\n background-image:url(".$imgUrl."/profil.gif);\n vertical-align:top;background-repeat:no-repeat;'\n background='".$imgUrl."/profil.gif' valign='top'>\n<div style='height:20px;line-height:20px;\n font-size:12px;color:rgb(255,255,255);padding:2px 0px 0px 5px;'>".$user->username."</div>\n<div style='height:100px;padding: 0px 0px 0px 2px'>\n<img src='".$photoDefautUser."' border='0' />\n<div style='padding:1px 4px 0px 4px;color:rgb(0,0,0);font-size:11px;line-height: 12px;'>\n	".$userLog->age." ".$lang_framework['Ans']."<br />".$userLog->nb_enfants." ".($userLog->nb_enfants > 1 ? ''.$lang_framework["Enfants"].'' : ''.$lang_framework["Enfant"].'')."<br />\n".makeSafe($userLog->canton)."</div></td>\n"								."<td style='font-size:14px;font-weight:bold;\n background-image:url(".$imgUrl."/box.jpg);\n color:rgb(205,1,114);\n text-align:center;vertical-align:middle;width:339px;\n height:164px;padding:0px 20px 0px 20px;'\n background='".$imgUrl."/box.jpg'>\n"				.$titre[$type]." !\n<br /><br />".$texte[$type]."</td>\n"								."<td style='width:120px;height:164px;vertical-align:top;padding:0px;' valign='top'><a href='".JL::url(SITE_URL.'/index.php?app=message&action=flower&user_to='.$user->username.'&'.$langue)."'\n style='display:block;width:119px;height:32px;margin:0px;padding:0px;'><img\n src='".$imgUrl."/rose2.jpg' border='0' /></a><img\n src='".$imgUrl."/".$icone[$type]."' style='display:block;margin:0px;padding:0px;width:119px;height:100px;' /><a\n href='".JL::url(SITE_URL.'/index.php?app=message&action=write&user_to='.$user->username)."'\n style='display:block;width:119px;height:29px;margin:0px;padding:0px;'><img\n src='".$imgUrl."/message2.jpg' border='0' /></a></td></tr></table></div>\n"								."<span style='font-family:Verdana;display:block;padding:80px 0px 0px 20px;width:570px;\n color:rgb(55,55,55);\n font-size:11px;font-style:italic;'>\n".$lang_framework['SiVousNeSouhaitz'].".</span>\n"								."</td></tr>\n"								."</table></div></body></html>"				;				mail($profil->email, $sujet, $message, $headers);							}					}						// conserve le dernier �v�nement effectu� sur un profil		function addLastEvent($user_id = 0, $last_event_user_id = 0, $last_event_type = 0, $last_event_data = 0) {			global $db;						$query = "UPDATE user_stats SET"			." last_event_user_id = '".(int)$last_event_user_id."',"			." last_event_type = '".(int)$last_event_type."',"			." last_event_data = '".(int)$last_event_data."'"			." WHERE user_id = '".(int)$user_id."'"			;			$db->query($query);					}						// ajoute des points � un utilisateur log		function addPoints($points_id, $user_id, $data = '') {			global $db;						// v�rifie si le classement du mois pr�c�dent a �t� �tabli			JL::rankingPoints();						// r�cup les infos de l'action			$query = "SELECT id, points, nb_max_par_data"			." FROM points"			." WHERE id = '".$db->escape($points_id)."'"			." LIMIT 0,1"			;			$point = $db->loadObject($query);						// si le nombre d'attributions de point est limit�			if($point->nb_max_par_data > 0) {							// check combien de fois l'utilisateur a �t� cr�dit pour cette action				$query = "SELECT COUNT(*)"				." FROM points_user"				." WHERE points_id = '".$db->escape($points_id)."' AND user_id = '".$db->escape($user_id)."' AND data LIKE '".$db->escape($data)."'"				;				$nb = (int)$db->loadResult($query);							// si le nombre de cr�dits limite a d�j� �t� attribu�				if($nb >= $point->nb_max_par_data) {					return false;				}						}						// insert le cr�dit dans la DB			$query = "INSERT INTO points_user SET"			." points_id = '".$db->escape($points_id)."',"			." user_id = '".$db->escape($user_id)."',"			." data = '".$db->escape($data)."',"			." datetime = NOW()"			;			$db->query($query);									// r�cup le nombre de points total de l'utilisateur			$query = "SELECT points_total FROM user_stats WHERE user_id = '".$db->escape($user_id)."'";			$points_total = $db->loadResult($query);						// mise � jour des stats de l'utilisateur			if($points_id == 20) { // retrait de points							$points_total_new = $points_total - (int)$data;						} else { // ajout de points							$points_total_new = $points_total + $point->points;						}						// mise � jour du total de points			$query = "UPDATE user_stats SET points_total = '".$db->escape($points_total_new)."' WHERE user_id = '".$db->escape($user_id)."'";			$db->query($query);							}						// d�termine s'il faut �tablir le classement du mois pr�c�dent. Ainsi, si le site est down le 1er du mois, le classement sera �tabli le 2. On est s�r de ne pas perdre un mois !		function rankingPoints() {			global $db;						$annee_mois = date('Y-m', mktime(0, 0, 0, date("m")-1, date("d"), date("Y")));						// r�cup un gagnant du mois pr�c�dent			$query = "SELECT id"			." FROM points_gagnants"			." WHERE annee_mois LIKE '".$db->escape($annee_mois)."'"			." LIMIT 0,1"			;			$gagnant = $db->loadResult($query);						// si le classement n'a pas �t� �tabli			if(!$gagnant) {											// variables locales				$where 		= array();				$_where		= '';												// exclue les profils helvetica media, les inactifs et suspendus				$where[]	= 'up.helvetica = 0';				$where[]	= 'u.confirmed = 1';				$where[]	= 'u.published = 1';								if (is_array($where)) {					$_where = " WHERE ".implode(" AND ", $where);				}												// r�cup les 10 premiers du classement actuel				$query = "SELECT u.id, u.username, us.points_total AS total"				." FROM user_stats AS us"				." INNER JOIN user AS u ON u.id = us.user_id"				." INNER JOIN user_profil AS up ON up.user_id = u.id"				.$_where				." ORDER BY us.points_total DESC, u.creation_date ASC"				." LIMIT 0,10"				;				$rows = $db->loadObjectList($query);								if(is_array($rows)) {									// 1�re place					if(isset($rows[0])) JL::winnerPoints($annee_mois, 1, $rows[0]);										// 2�me place					if(isset($rows[1])) JL::winnerPoints($annee_mois, 2, $rows[1]);										// 3�me place					if(isset($rows[2])) JL::winnerPoints($annee_mois, 3, $rows[2]);										// enregistre les 10 premiers du classement					foreach($rows as $row) {											$query = "INSERT INTO points_classements SET"						." user_id = '".$db->escape($row->id)."',"						." points = '".$db->escape($row->total)."',"						." annee_mois = '".$db->escape($annee_mois)."'"						;						$db->query($query);										}								}							}					}						// enregistre un gagnant		function winnerPoints($annee_mois, $position, &$row) {include("lang/app_framework.".$_GET['lang'].".php");			global $db;						// r�cup les infos d�j� connues			$query = "SELECT nom, prenom, adresse, code_postal"			." FROM user_profil"			." WHERE user_id = '".$db->escape($row->id)."'"			." LIMIT 0,1"			;			$winner = $db->loadResult($query);						// sauvegarde le gagnant (dumoins les infos connues ou pr�sum�es)			$query = "INSERT INTO points_gagnants SET"			." annee_mois = '".$db->escape($annee_mois)."',"			." user_id = '".$db->escape($row->id)."',"			." nom = '".$db->escape($winner->nom)."',"			." prenom = '".$db->escape($winner->prenom)."',"			." adresse = '".$db->escape($winner->adresse)."',"			." code_postal = '".$db->escape($winner->code_postal)."',"			." position = '".$db->escape($position)."'"			;			$db->query($query);						// position � utiliser dans le MP			$positionTxt 	= '';			$valeurTxt		= '';			switch($position) {							case 1:					$positionTxt 	= ''.$lang_framework["Ere1"].'';					$valeurTxt		= '279.90';					$gammeTxt		= ''.$lang_framework["DansLaGammeSensation"].'';				break;								case 2:					$positionTxt 	= ''.$lang_framework["Eme2"].'';					$valeurTxt		= '149.90';					$gammeTxt		= ''.$lang_framework["DansLaGammeCoffret"].'';				break;								case 3:					$positionTxt 	= ''.$lang_framework["Eme3"].'';					$valeurTxt		= '79.90';					$gammeTxt		= ''.$lang_framework["DansLaGammeAventure"].'';				break;						}						// r�cup le MP de victoire			$query = "SELECT titre, texte"			." FROM notification"			." WHERE id = 4"			." LIMIT 0,1"			;			$mp = $db->loadObject($query);						// envoi du MP d'annonce de victoire			$query = "INSERT INTO message SET"			." user_id_from = '1',"			." user_id_to = '".$db->escape($row->id)."',"			." titre = '".$mp->titre."',"			." texte = '".$db->escape(sprintf($mp->texte, $row->username, $positionTxt, date('m/Y', mktime(0, 0, 0, date("m")-1, date("d"), date("Y"))), $gammeTxt, $valeurTxt))."',"			." date_envoi = NOW()"			;			$db->query($query);						// remise � 0 des points du gagnant			$query = "UPDATE user_stats SET points_total = 0 WHERE user_id = '".$db->escape($row->id)."'";			$db->query($query);					}				// remplace les mots cl�s du genre {texte}, {site_url}, {username}, etc...		function getMailHtml($templatePath, $titre = '', $texte = '', $username = '', $var = null) {						// r�cup le code html du template			$html		= str_replace('{texte}', 	$texte, 	file_get_contents($templatePath));						// remplace les mots cl�s			$html		= str_replace('{titre}', 	$titre, 	$html);			$html		= str_replace('{username}', $username, 	$html);			$html		= str_replace('{site_url}', SITE_URL, 	$html);						if(is_array($var)) {				$count = count($var);				for($i=0; $i<$count; $i++) $html = str_replace('{var'.($i+1).'}', $var[$i], $html);			}						return $html;				}						/* ******************************************************************************************************************************* */											// FONCTIONS ISSUES DE JOOMLA		/* ******************************************************************************************************************************* */						function makeOption($value, $text='', $value_name='value', $text_name='text') {			$obj = new stdClass;			$obj->$value_name = $value;			$obj->$text_name = trim( $text ) ? $text : $value;			return $obj;		}				/**		* Generates an HTML select list		* @param array An array of objects		* @param string The value of the HTML name attribute		* @param string Additional HTML attributes for the <select> tag		* @param string The name of the object variable for the option value		* @param string The name of the object variable for the option text		* @param mixed The key that is selected		* @returns string HTML for the select list		*/		function makeSelectList( &$arr, $tag_name, $tag_attribs, $key, $text, $selected=NULL ) {			// check if array			if ( is_array( $arr ) ) {				reset( $arr );			}			$html 	= "\n<select name=\"$tag_name\" $tag_attribs>";			$count 	= count( $arr );			for ($i=0, $n=$count; $i < $n; $i++ ) {				$k = $arr[$i]->$key;				$t = $arr[$i]->$text;				$id = ( isset($arr[$i]->id) ? @$arr[$i]->id : null);				$extra = '';				$extra .= $id ? " id=\"" . $arr[$i]->id . "\"" : '';				if (is_array( $selected )) {					foreach ($selected as $obj) {						$k2 = $obj->$key;						if ($k == $k2) {							$extra .= " selected=\"selected\"";							break;						}					}				} else {					$extra .= ($k == $selected ? " selected=\"selected\"" : '');				}				$html .= "\n\t<option value=\"".$k."\"$extra>" . makeSafe($t) . "</option>";			}			$html .= "\n</select>\n";			return $html;		}			}	?>